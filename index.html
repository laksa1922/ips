<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Pompa & Tandon</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0; padding: 0;
      background: #121212;
      color: #f1f1f1;
      transition: 0.3s;
    }
    header {
      background: #1e1e1e;
      padding: 15px;
      text-align: center;
      font-size: 22px;
      font-weight: bold;
      border-bottom: 2px solid #444;
    }
    .container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 20px;
      padding: 20px;
    }
    .card {
      background: #1e1e1e;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.5);
      transition: 0.3s;
    }
    .card:hover { transform: translateY(-5px); }
    h2 {
      margin-top: 0;
      font-size: 20px;
      border-bottom: 1px solid #333;
      padding-bottom: 5px;
    }
    .status {
      font-size: 18px;
      margin: 10px 0;
    }
    .status span {
      font-weight: bold;
      padding: 5px 10px;
      border-radius: 10px;
    }
    .on { background: #28a745; color: white; animation: pulse 1.5s infinite; }
    .off { background: #dc3545; color: white; }
    @keyframes pulse {
      0% { box-shadow: 0 0 5px #28a745; }
      50% { box-shadow: 0 0 20px #28a745; }
      100% { box-shadow: 0 0 5px #28a745; }
    }
    .warning { color: #ff9800; font-weight: bold; }
    .critical { color: #f44336; font-weight: bold; }
    .info { font-size: 14px; color: #bbb; margin-top: 5px; }
    .dark-toggle {
      position: fixed;
      top: 10px; right: 10px;
      padding: 8px 12px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      background: #444;
      color: white;
    }
    canvas { margin-top: 10px; }
  </style>
</head>
<body>
  <header>📊 Dashboard Monitoring Pompa & Tandon</header>
  <button class="dark-toggle" onclick="toggleDarkMode()">🌙 Mode Gelap</button>
  
  <div class="container">
    <!-- Joglo -->
    <div class="card">
      <h2>🏠 Joglo</h2>
      <div class="status">Pompa: <span id="pompaJoglo">Loading...</span></div>
      <div>Level Tandon: <span id="tandonJoglo">-</span>%</div>
      <div>Suhu Pompa: <span id="suhuJoglo">-</span> °C</div>
      <div class="info">📶 RSSI: <span id="rssiJoglo">-</span> | 🌐 IP: <span id="ipJoglo">-</span></div>
      <canvas id="chartJoglo" height="100"></canvas>
    </div>

    <!-- Kantin -->
    <div class="card">
      <h2>🍴 Kantin</h2>
      <div class="status">Pompa: <span id="pompaKantin">Loading...</span></div>
      <div>Level Tandon: <span id="tandonKantin">-</span>%</div>
      <div>Suhu Pompa: <span id="suhuKantin">-</span> °C</div>
      <div class="info">📶 RSSI: <span id="rssiKantin">-</span> | 🌐 IP: <span id="ipKantin">-</span></div>
      <canvas id="chartKantin" height="100"></canvas>
    </div>

    <!-- Lantai 6 -->
    <div class="card">
      <h2>🏢 Lantai 6</h2>
      <div class="status">Pompa: <span id="pompaLt6">Loading...</span></div>
      <div>Level Tandon: <span id="tandonLt6">-</span>%</div>
      <div>Suhu Pompa: <span id="suhuLt6">-</span> °C</div>
      <div class="info">📶 RSSI: <span id="rssiLt6">-</span> | 🌐 IP: <span id="ipLt6">-</span></div>
      <canvas id="chartLt6" height="100"></canvas>
    </div>
  </div>

  <script>
    // Link Google Sheets CSV
    const sheets = {
      joglo: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTf9RrlaFN7h2UMkV_KRWJ0hU53Uwp2kCyjwduvxkvhv7rqJc7j71mXBai3hF3aW6R7EGYNzi5TWQSs/pub?gid=0&single=true&output=csv",
      kantin: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRp3hZufwknJEpOfvD_6YlB_lQEWwcJ-hMgKVfNoV1-jJAKeQB979Acs69cXCKCZVkf01OhwFn8fHlD/pub?gid=0&single=true&output=csv",
      lt6: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRp3hZufwknJEpOfvD_6YlB_lQEWwcJ-hMgKVfNoV1-jJAKeQB979Acs69cXCKCZVkf01OhwFn8fHlD/pub?gid=0&single=true&output=csv"
    };

    async function fetchCSV(url) {
      const res = await fetch(url);
      const text = await res.text();
      const rows = text.trim().split("\n").map(r => r.split(","));
      return rows;
    }

    async function updateDashboard() {
      await updateCard("Joglo", sheets.joglo);
      await updateCard("Kantin", sheets.kantin);
      await updateCard("Lt6", sheets.lt6);
    }

    async function updateCard(lokasi, url) {
      try {
        const rows = await fetchCSV(url);
        const last = rows[rows.length - 1]; // ambil baris terakhir
        // sesuaikan urutan kolom dengan sheet kamu
        let [waktu, pompa, level, suhu, rssi, ip] = last;

        document.getElementById(`pompa${lokasi}`).textContent = pompa;
        document.getElementById(`pompa${lokasi}`).className = pompa === "ON" ? "on" : "off";
        document.getElementById(`tandon${lokasi}`).textContent = level;
        document.getElementById(`suhu${lokasi}`).textContent = suhu;
        document.getElementById(`rssi${lokasi}`).textContent = rssi;
        document.getElementById(`ip${lokasi}`).textContent = ip;

        // Warning suhu
        if(suhu >= 45) document.getElementById(`suhu${lokasi}`).className = "critical";
        else if(suhu >= 40) document.getElementById(`suhu${lokasi}`).className = "warning";
        else document.getElementById(`suhu${lokasi}`).className = "";

        // Chart update
        const chartId = `chart${lokasi}`;
        if (!window[chartId]) {
          window[chartId] = new Chart(document.getElementById(chartId), {
            type: 'bar',
            data: {
              labels: ["Level", "Suhu"],
              datasets: [{
                data: [level, suhu]
              }]
            },
            options: { responsive: true, plugins: { legend: { display: false } } }
          });
        } else {
          window[chartId].data.datasets[0].data = [level, suhu];
          window[chartId].update();
        }
      } catch (e) {
        console.error(`Gagal load data ${lokasi}`, e);
      }
    }

    // auto update tiap 10 detik
    setInterval(updateDashboard, 10000);
    updateDashboard();

    // Dark mode toggle
    function toggleDarkMode() {
      if (document.body.style.background === "white") {
        document.body.style.background = "#121212";
        document.body.style.color = "#f1f1f1";
      } else {
        document.body.style.background = "white";
        document.body.style.color = "black";
      }
    }
  </script>
</body>
</html>
